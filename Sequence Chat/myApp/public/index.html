<!DOCTYPE html>
<html xmlns:float="http://www.w3.org/1999/xhtml">
<head>
  <title>SocketCluster</title>
  <link href="//fonts.googleapis.com/css?family=Roboto:100,300" rel="stylesheet" type="text/css">
  <link rel="icon" type="image/png" href="/favicon.ico">
  <link rel="stylesheet" href="style.css" type="text/css">
  <script type="text/javascript" src="/socketcluster.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gojs/1.8.2/go.js"></script>
</head>
<body>
<header>
  <h1 id="center">Sequence C(h)at</h1>
</header>
<div id="dump">
  <div id="drop_zone">
    <h2> Drop Your JSon File here</h2>
  </div>
  <!--<input type="file" id="input">-->
  <!--<input type="file" class="button" id="input" style="float: left; width:5%">-->

  <label for="file-upload" class="custom-file-upload">
    <i class="fa fa-cloud-upload"></i> Select File
  </label>
  <input id="file-upload" type="file"/>
  <!--<input type='button' id='btnLoad' value='Load' onclick="loadFile(); this.style.visibility='hidden'" />-->
  <input type="button" class="button" value="Execute" onclick="loadFile();"  style="float: right;  width: 9.9%;">


</div>

    <div id="deployDiagramDiv"
       style="width:500px; height:500px; background-color: transparent;">
    </div>

        <div id="classDiagramDiv"
     style="width:500px; height:500px; background-color: transparent;">
    </div>


<div class="l-wrap" id="wrap">
</div>

<div class="execution_log" id='execution_log'>
execution log

</div>

<script type="text/javascript">


    // Initiate the connection to the server
    console.log("he");
    var socket = socketCluster.connect();
    socket.on('error', function (err) {
        throw 'Socket error - ' + err;
    });
    socket.on('connect', function () {
        console.log('CONNECTED');
    });

    var channels = [];
     var sampleChannel = socket.subscribe('sample');
     var deployChannel = socket.subscribe('deploy');
     var classChannel = socket.subscribe('class');

      sampleChannel.on('subscribeFail', function (err) {
        console.log('Failed to subscribe to the sequence channel due to error: ' + err);
      });
      deployChannel.on('subscribeFail', function (err) {
        console.log('Failed to subscribe to the deploy channel due to error: ' + err);
      });
      classChannel.on('subscribeFail', function (err) {
        console.log('Failed to subscribe to the class channel due to error: ' + err);
      });

    function loadFile() {
        var file, fr;

        if (typeof window.FileReader !== 'function') {
            alert("The file API isn't supported on this browser yet.");
            return;
        }
        var file = document.getElementById('file-upload').files[0];
        fr = new FileReader();
        fr.onload = receivedText;
        fr.readAsText(file);

        function receivedText(e) {
            jsonData = e.target.result;
            socket.emit('go', jsonData);
        }
    }

    deployChannel.watch(function(data){
      var $ = go.GraphObject.make;
      var myDiagram =
        $(go.Diagram, "deployDiagramDiv",
          {
            initialContentAlignment: go.Spot.Center, // center Diagram contents
            "undoManager.isEnabled": true, // enable Ctrl-Z to undo and Ctrl-Y to redo
            layout: $(go.TreeLayout, // specify a Diagram.layout that arranges trees
                      { angle: 90, layerSpacing: 35 })
          });
      // the template we defined earlier
      myDiagram.nodeTemplate =
        $(go.Node, "Auto",
          { background: "rgba(0, 0, 0, 0.05)"},
          $(go.TextBlock, "Default Text",
            { margin: 12, stroke: "white", font: "bold 16px sans-serif" },
            new go.Binding("text", "name"))
        );

      // define a Link template that routes orthogonally, with no arrowhead
      myDiagram.linkTemplate =
        $(go.Link,
          { routing: go.Link.Orthogonal, corner: 5 },
          $(go.Shape, { strokeWidth: 3, stroke: "#555" })); // the link shape
      var model = $(go.TreeModel);
      model.nodeDataArray = data
      myDiagram.model = model;
    })

    classChannel.watch(function (data){
      var $ = go.GraphObject.make;
      myDiagram =
      $(go.Diagram, "classDiagramDiv",
        {
          initialContentAlignment: go.Spot.Center,
          "undoManager.isEnabled": true,
          layout: $(go.TreeLayout,
                    { // this only lays out in trees nodes connected by "generalization" links
                      angle: 90,
                      path: go.TreeLayout.PathSource,  // links go from child to parent
                      setsPortSpot: false,  // keep Spot.AllSides for link connection spot
                      setsChildPortSpot: false,  // keep Spot.AllSides
                      // nodes not connected by "generalization" links are laid out horizontally
                      arrangement: go.TreeLayout.ArrangementHorizontal
                    })
        });

      var propertyTemplate =
      $(go.Panel, "Horizontal",
        $(go.TextBlock,
          { isMultiline: false, editable: true },
          new go.Binding("text", "name").makeTwoWay(),
          new go.Binding("isUnderline", "scope", function(s) { return s[0] === 'c' })),
        // property type, if known
        $(go.TextBlock, "",
          new go.Binding("text", "type", function(t) { return (t ? ": " : ""); })),
        $(go.TextBlock,
          { isMultiline: false, editable: true },
          new go.Binding("text", "type").makeTwoWay()),
        // property default value, if any
        $(go.TextBlock,
          { isMultiline: false, editable: false },
          new go.Binding("text", "default", function(s) { return s ? " = " + s : ""; }))
      );
    
    // the item template for methods
      var methodTemplate =
      $(go.Panel, "Horizontal",
        $(go.TextBlock,
          { isMultiline: false, editable: true },
          new go.Binding("text", "name").makeTwoWay(),
          new go.Binding("isUnderline", "scope", function(s) { return s[0] === 'c' })),
        // method parameters
        $(go.TextBlock, "()",
          // this does not permit adding/editing/removing of parameters via inplace edits
          new go.Binding("text", "parameters", function(parr) {
              var s = "(";
              for (var i = 0; i < parr.length; i++) {
                var param = parr[i];
                if (i > 0) s += ", ";
                s += param.name + ": " + param.type;
              }
              return s + ")";
          })),
        // method return type, if any
        $(go.TextBlock, "",
          new go.Binding("text", "type", function(t) { return (t ? ": " : ""); })),
        $(go.TextBlock,
          { isMultiline: false, editable: true },
          new go.Binding("text", "type").makeTwoWay())
      );

      myDiagram.nodeTemplate =
      $(go.Node, "Auto",
        {
          locationSpot: go.Spot.Center,
          fromSpot: go.Spot.AllSides,
          toSpot: go.Spot.AllSides
        },
        $(go.Shape, { fill: "#6A5ACD" }),
        $(go.Panel, "Table",
          { defaultRowSeparatorStroke: "black" },
          // header
          $(go.TextBlock,
            {
              row: 0, columnSpan: 2, margin: 3, alignment: go.Spot.Center,
              font: "bold 12pt sans-serif",
              isMultiline: false, editable: true
            },
            new go.Binding("text", "name").makeTwoWay()),
          // properties
          $(go.TextBlock, "Properties",
            { row: 1, font: "italic 10pt sans-serif" },
            new go.Binding("visible", "visible", function(v) { return !v; }).ofObject("PROPERTIES")),
          $(go.Panel, "Vertical", { name: "PROPERTIES" },
            new go.Binding("itemArray", "properties"),
            {
              row: 1, margin: 3, stretch: go.GraphObject.Fill,
              defaultAlignment: go.Spot.Left, background: "#6A5ACD", // highlighting the text
              itemTemplate: propertyTemplate
            }
          ),

          $("PanelExpanderButton", "PROPERTIES",
            { row: 1, column: 1, alignment: go.Spot.TopRight, visible: false },
            new go.Binding("visible", "properties", function(arr) { return arr.length > 0; })),
          // methods
          $(go.TextBlock, "Methods",
            { row: 2, font: "italic 10pt sans-serif" },
            new go.Binding("visible", "visible", function(v) { return !v; }).ofObject("METHODS")),
          $(go.Panel, "Vertical", { name: "METHODS" },
            new go.Binding("itemArray", "methods"),
            {
              row: 2, margin: 3, stretch: go.GraphObject.Fill,
              defaultAlignment: go.Spot.Left, background: "#6A5ACD", // highlight method text
              itemTemplate: methodTemplate
            }
          ),

          $("PanelExpanderButton", "METHODS",
            { row: 2, column: 1, alignment: go.Spot.TopRight, visible: false },
            new go.Binding("visible", "methods", function(arr) { return arr.length > 0; }))
        )
      );


      function convertIsTreeLink(r) {
        switch (r) {
        case "aggregation": return r === "aggregation";
        case "generalization": return r === "generalization";
        case "inheritance": return r === "inheritance";
        case "composition": return r === "composition";
      }
    }
      function convertFromArrow(r) {
        switch (r) {
        case "aggregation": return "";
        case "generalization": return"";
        case "inheritance": return"";
        case "composition": return"";
        default: return "";
      }
    }
      function convertToArrow(r) {
        switch (r) {
        case "generalization": return"Triangle";
        case "inheritance": return "Triangle";
        case "aggregation": return "StretchedDiamond";
        case "composition": return "StretchedDiamond";
        default: return "";
      }
    }
/*      function whatColor(r){
        switch (r) {
        case "generalization": return"white";
        case "inheritance": return "white";
        case "aggregation": return "white";
        case "composition": return "black";
      }
    }*/
      myDiagram.linkTemplate =
      $(go.Link,
        { routing: go.Link.Orthogonal },
        new go.Binding("isLayoutPositioned", "relationship", convertIsTreeLink),
        $(go.Shape),
        $(go.Shape, { scale: 1.3, fill: "white" },
          new go.Binding("fromArrow", "relationship", convertFromArrow)),
        $(go.Shape, { scale: 1.3, fill: "white" },
          new go.Binding("toArrow", "relationship", convertToArrow))
       
      );

      myDiagram.model = $(go.GraphLinksModel,
      {
        copiesArrays: true,
        copiesArrayObjects: true,
        nodeDataArray: data[0],
        linkDataArray: data[1]
      });

    })

    sampleChannel.watch(function (data) {

        var fro = data.from;
        var user = data.to;
        if (user !== undefined) {
            var currentdate = new Date();
            var datetime = currentdate.getMinutes() + ":"
                + currentdate.getSeconds();
            var div = document.getElementById('wrap');
            var self = document.getElementById(fro+user);
            var other = document.getElementById(user+fro);
            var executionLog = document.getElementById('execution_log');
            var message = data.message;

            if (channels.includes(user + fro)) {

                    other.innerHTML +=
                        '<li class="other">' +
                        '<div class="messages">' +
                        '<p id="message" class="animate">' + message + '</p>' +
                        '<time>' +
                        fro + ' • ' + datetime +
                        '</time>' +
                        '</div>' +
                        '</li>';
                }
                else if (channels.includes(fro + user)) {
                    self.innerHTML +=
                        '<li class="self">' +
                        '<div class="messages">' +
                        '<p id="message" class="animate">' + message + '</p>' +
                        '<time>' +
                        fro + ' • ' + datetime +
                        '</time>' +
                        '</div>' +
                        '</li>';
                }
                else {
                    div.innerHTML +=
                        '<div class="three-col-grid">' +
                        '<div class="grid-item">' +
                        '<section class="module">' +
                        '<div class="top-bar">' +
                        '<div class="left">' +
                        '<span class="icon typicons-message"></span>' +
                        '<h1 id="user">' + fro + " and " + user + '</h1>' +
                        '</div>' +
                        '</div>' +
                        '<ol class="discussion" id="' + user + fro + '">' +
                        '<li class="other">' +
                        '<div class="messages">' +
                        '<p id="message " class="animate">' + message + '</p>' +
                        '<time id="time">' + fro + ' • ' + datetime + '</time>' +
                        '</div>' +
                        '</li>' +
                        '</ol>' +
                        '</section>' +
                        '</div>' +
                        '</div>';
                    channels.push(user + fro);
                }
            }

            //document.getElementById('user').innerHTML = data.from;
            //document.getElementById('message').innerHTML +=  data.message[2];
            console.log('RANDOM STREAM: ' + data.from + data.to + data.message);
            executionLog.innerHTML+= '' + data.from + '' + data.to+ '' + data.message;
    });




    var box = document.getElementById("execution_log");
    function expandBox(){
        if(box.getAttribute("expanded")=="false"){
            box.setAttribute("expanded","true");
            box.style.height="250px";
            box.style.display="block";
        }else{
            box.setAttribute("expanded","false");
            box.style.height="20px";

        }
    }
    document.getElementById("execution_log").onclick = expandBox;
</script>
</body>
</html>
